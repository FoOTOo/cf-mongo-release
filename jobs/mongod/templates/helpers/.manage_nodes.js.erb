<%
def discover_external_ip
    networks = spec.networks.marshal_dump
    _, network = networks.find do |_name, network_spec|
      network_spec.default
    end
    if !network
      _, network = networks.first
    end
    if !network
      raise "Could not determine IP via network spec: #{networks}"
    end
    network.ip
  end
  network_ip = discover_external_ip 
%>
use admin;
db.auth("<%= p("mongod.root.user") %>", "<%= p("mongod.root.pass") %>");
var privateIp = "<%= network_ip %>";
var cfgNodes = <%= p("mongod.nodes.ips") %>;

var hosts = db.isMaster()["hosts"];
var port = <%= p("mongod.nodes.port") %>;


// add new nodes
cfgNodes.forEach(function(node, index) {
	nodeWithPort = node + ":" + port;
	if (hosts.indexOf(nodeWithPort) == -1) {
		rs.add(node, port);
	}
});

// delete nodes that are no longer required
hosts.forEach(function(host, index) {
	hostWithoutPort = host.split(":", 1);
	if (cfgNodes.indexOf(hostWithoutPort) == -1) {
		rs.remove(hostWithoutPort, port);
	}
});